<h1 class="page-title">Food log history</h1>

<p>
  Review your food entries by day. Click the table headers to sort. Default sort is by Date (newest first).
</p>

<% if @grouped_logs.present? %>
  <% # Sort groups by date when sorting by date; otherwise keep groups newest-first %>
  <% grouped_keys = @grouped_logs.keys.sort %>
  <% grouped_keys.reverse! if @sort == 'date' && @direction == 'desc' %>
  <% if @sort != 'date' %>
    <% grouped_keys = @grouped_logs.keys.sort.reverse %>
  <% end %>

  <% grouped_keys.each do |date| %>
    <section class="day-group">
      <h2><strong><%= l(date, format: :long) %></strong></h2>
      <table class="table">
        <thead>
          <tr>
            <th><%= history_sort_link("Date", "date", @sort, @direction) %></th>
            <th>Food</th>
            <th><%= history_sort_link("Calories", "calories", @sort, @direction) %></th>
            <th><%= history_sort_link("Proteins", "protein_g", @sort, @direction) %></th>
            <th><%= history_sort_link("Fats", "fats_g", @sort, @direction) %></th>
            <th><%= history_sort_link("Carbs", "carbs_g", @sort, @direction) %></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% logs = @grouped_logs[date] %>
          <% # Sort within the day based on selected column %>
          <% sorted = case @sort
                      when 'date'
                        logs.sort_by(&:created_at)
                      when 'calories'
                        logs.sort_by { |l| l.calories.to_i }
                      when 'protein_g'
                        logs.sort_by { |l| l.protein_g.to_i }
                      when 'fats_g'
                        logs.sort_by { |l| l.fats_g.to_i }
                      when 'carbs_g'
                        logs.sort_by { |l| l.carbs_g.to_i }
                      else
                        logs
                      end %>
          <% sorted.reverse! if @direction == 'desc' %>

          <% sorted.each do |log| %>
            <tr>
              <td>
                <time data-controller="local-time" data-local-time-format-value="short" datetime="<%= log.created_at.iso8601 %>">
                  <%= l log.created_at, format: :short %>
                </time>
              </td>
              <td>
                <strong><%= log.food_name %></strong>
                <% if log.photo.attached? %>
                  <div class="thumbnail">
                    <%= image_tag log.photo, alt: "#{log.food_name} photo" %>
                  </div>
                <% end %>
              </td>
              <td><%= log.calories %></td>
              <td><%= log.protein_g %> g</td>
              <td><%= log.fats_g %> g</td>
              <td><%= log.carbs_g %> g</td>
              <td>
                <div class="log-actions">
                  <%= link_to "Edit", edit_food_log_path(log), class: "btn btn-link" %>
                  <%= button_to "Delete", food_log_path(log), method: :delete, data: { confirm: "Delete this entry?" }, class: "btn btn-link" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </section>
  <% end %>
<% else %>
  <p>You haven't logged any meals yet.</p>
<% end %>

<%= link_to "Back to dashboard", dashboard_path, class: "btn" %>
