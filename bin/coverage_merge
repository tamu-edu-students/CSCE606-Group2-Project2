#!/usr/bin/env ruby
# frozen_string_literal: true

require 'simplecov'
require 'fileutils'

# Find SimpleCov resultset files produced by parallel runs
resultset_paths = Dir.glob('coverage/**/.resultset*.json')
resultset_paths << 'coverage/.resultset.json' if resultset_paths.empty? && File.exist?('coverage/.resultset.json')

if resultset_paths.empty?
  puts 'No SimpleCov resultset files found; nothing to merge.'
  exit 0
end

coverage_dirs = resultset_paths.map { |p| File.dirname(p) }.uniq
puts "Merging coverage results from: #{coverage_dirs.join(', ')}"

# Collate the coverage results. This will produce coverage reports in the default coverage directory.
SimpleCov.collate(coverage_dirs, 'Merged Coverage') do
  # Use default HTML formatter (SimpleCov::Formatter::HTMLFormatter)
  SimpleCov.formatter = SimpleCov::Formatter::HTMLFormatter
  coverage_dir 'coverage'
end

puts 'Coverage merge complete.'
